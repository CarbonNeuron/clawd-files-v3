@page "/admin"
@using ClawdFiles.Application.Services
@inject KeyManagementService KeyService
@inject BucketService BucketService
@rendermode InteractiveServer

<PageTitle>Admin Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h3" GutterBottom="true">Admin Dashboard</MudText>

    <MudText Typo="Typo.h5" GutterBottom="true">API Keys</MudText>
    @if (keys is null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudSimpleTable Elevation="1" Hover="true" Dense="true" Class="mb-8">
            <thead>
                <tr>
                    <th>Prefix</th>
                    <th>Name</th>
                    <th>Created</th>
                    <th>Last Used</th>
                    <th>Buckets</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var key in keys)
                {
                    <tr>
                        <td>@key.Prefix</td>
                        <td>@key.Name</td>
                        <td>@key.CreatedAt.ToString("u")</td>
                        <td>@(key.LastUsedAt?.ToString("u") ?? "Never")</td>
                        <td>@key.BucketCount</td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>
    }

    <MudText Typo="Typo.h5" GutterBottom="true">All Buckets</MudText>
    @if (buckets is null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudSimpleTable Elevation="1" Hover="true" Dense="true">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Files</th>
                    <th>Created</th>
                    <th>Expires</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var b in buckets)
                {
                    <tr>
                        <td><MudLink Href="@($"/{b.Id}")">@b.Id</MudLink></td>
                        <td>@b.Name</td>
                        <td>@b.FileCount</td>
                        <td>@b.CreatedAt.ToString("u")</td>
                        <td>@(b.ExpiresAt?.ToString("u") ?? "Never")</td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>
    }
</MudContainer>

@code {
    private List<ClawdFiles.Application.DTOs.KeyInfoResponse>? keys;
    private List<ClawdFiles.Application.DTOs.BucketListItemResponse>? buckets;

    protected override async Task OnInitializedAsync()
    {
        keys = await KeyService.ListKeysAsync();
        buckets = await BucketService.ListBucketsAsync(null, isAdmin: true);
    }
}
