@page "/{BucketId}"
@using ClawdFiles.Application.Services
@inject BucketService BucketService
@rendermode InteractiveServer

<PageTitle>@(bucket?.Name ?? "Bucket")</PageTitle>

<div style="padding-top: 40px;">
    @if (bucket is null)
    {
        <div class="sonar-loader">
            <div class="sonar-ping"><div class="sonar-ping-dot"></div></div>
        </div>
    }
    else
    {
        <div class="breadcrumb-path anim-fade-in">
            <a href="/">home</a>
            <span class="breadcrumb-path-sep">/</span>
            <span>@bucket.Id</span>
        </div>

        <h1 class="hero-title" style="font-size: 1.8rem !important; margin-bottom: 8px;">@bucket.Name</h1>

        @if (!string.IsNullOrEmpty(bucket.Description))
        {
            <p class="hero-subtitle anim-fade-in anim-delay-1" style="font-size: 1rem !important; margin-bottom: 24px;">@bucket.Description</p>
        }

        <div class="meta-bar anim-fade-in anim-delay-1" style="margin-bottom: 32px;">
            <span class="meta-tag">
                <span class="meta-tag-label">ID</span> @bucket.Id
            </span>
            @if (!string.IsNullOrEmpty(bucket.Purpose))
            {
                <span class="meta-tag meta-tag--cyan">
                    <span class="meta-tag-label">Purpose</span> @bucket.Purpose
                </span>
            }
            <span class="meta-tag">
                <span class="meta-tag-label">Created</span> @bucket.CreatedAt.ToString("u")
            </span>
            @if (bucket.ExpiresAt.HasValue)
            {
                <span class="meta-tag meta-tag--amber">
                    <span class="meta-tag-label">Expires</span> @bucket.ExpiresAt.Value.ToString("u")
                </span>
            }
        </div>

        <div class="terminal-panel anim-fade-in anim-delay-2">
            <div class="terminal-panel-header">
                <div class="terminal-panel-header-dot"></div>
                <span class="terminal-panel-header-title">Files &mdash; @bucket.Files.Count item@(bucket.Files.Count != 1 ? "s" : "")</span>
            </div>

            @if (bucket.Files.Count == 0)
            {
                <div class="terminal-panel-body" style="text-align: center; color: var(--abyss-muted); font-family: var(--font-mono); font-size: 0.85rem;">
                    No files in this bucket.
                </div>
            }
            else
            {
                <div class="file-row-header">
                    <span>Name</span>
                    <span>Type</span>
                    <span>Size</span>
                    <span>Actions</span>
                </div>
                @foreach (var file in bucket.Files)
                {
                    <div class="file-row">
                        <div class="file-row-name">
                            <a href="/@bucket.Id/@file.Path">@file.Path</a>
                        </div>
                        <span class="file-badge">@GetShortType(file.ContentType)</span>
                        <span class="file-row-size">@FormatSize(file.SizeBytes)</span>
                        <span class="file-row-action"><a href="/raw/@bucket.Id/@file.Path">download</a></span>
                    </div>
                }
            }
        </div>

        @if (bucket.Files.Count > 0)
        {
            <div style="margin-top: 20px;" class="anim-fade-in anim-delay-3">
                <MudButton Href="@($"/api/buckets/{bucket.Id}/zip")"
                           Variant="Variant.Filled"
                           Color="Color.Primary">
                    Download all as ZIP
                </MudButton>
            </div>
        }
    }
</div>

@code {
    [Parameter] public string BucketId { get; set; } = "";
    private ClawdFiles.Application.DTOs.BucketResponse? bucket;

    protected override async Task OnInitializedAsync()
    {
        bucket = await BucketService.GetBucketAsync(BucketId);
    }

    private static string FormatSize(long bytes)
    {
        const long kb = 1024;
        const long mb = 1024 * 1024;
        const long gb = 1024 * 1024 * 1024;
        if (bytes >= gb) return $"{bytes / (double)gb:F1} GB";
        if (bytes >= mb) return $"{bytes / (double)mb:F1} MB";
        if (bytes >= kb) return $"{bytes / (double)kb:F1} KB";
        return $"{bytes} B";
    }

    private static string GetShortType(string contentType)
    {
        var sub = contentType.Contains('/') ? contentType.Split('/')[1] : contentType;
        return sub.Length > 10 ? sub[..10] : sub;
    }
}
