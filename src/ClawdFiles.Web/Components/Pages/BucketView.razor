@page "/{BucketId}"
@using ClawdFiles.Application.Services
@inject BucketService BucketService
@rendermode InteractiveServer

<PageTitle>@(bucket?.Name ?? "Bucket")</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    @if (bucket is null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudText Typo="Typo.h3" GutterBottom="true">@bucket.Name</MudText>
        @if (!string.IsNullOrEmpty(bucket.Description))
        {
            <MudText Typo="Typo.body1" Class="mb-4">@bucket.Description</MudText>
        }
        <div class="d-flex flex-wrap gap-2 mb-4">
            <MudChip T="string" Color="Color.Default">ID: @bucket.Id</MudChip>
            @if (!string.IsNullOrEmpty(bucket.Purpose))
            {
                <MudChip T="string" Color="Color.Info">Purpose: @bucket.Purpose</MudChip>
            }
            <MudChip T="string" Color="Color.Default">Created: @bucket.CreatedAt.ToString("u")</MudChip>
            @if (bucket.ExpiresAt.HasValue)
            {
                <MudChip T="string" Color="Color.Warning">Expires: @bucket.ExpiresAt.Value.ToString("u")</MudChip>
            }
        </div>

        <MudText Typo="Typo.h5" GutterBottom="true">Files (@bucket.Files.Count)</MudText>

        @if (bucket.Files.Count == 0)
        {
            <MudText Typo="Typo.body1">No files in this bucket.</MudText>
        }
        else
        {
            <MudSimpleTable Elevation="1" Hover="true" Dense="true">
                <thead>
                    <tr>
                        <th>Path</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var file in bucket.Files)
                    {
                        <tr>
                            <td><MudLink Href="@($"/{bucket.Id}/{file.Path}")">@file.Path</MudLink></td>
                            <td>@file.ContentType</td>
                            <td>@FormatSize(file.SizeBytes)</td>
                            <td><MudLink Href="@($"/raw/{bucket.Id}/{file.Path}")">Download</MudLink></td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>

            <MudButton Href="@($"/api/buckets/{bucket.Id}/zip")"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Download"
                       Class="mt-4">
                Download all as ZIP
            </MudButton>
        }
    }
</MudContainer>

@code {
    [Parameter] public string BucketId { get; set; } = "";
    private ClawdFiles.Application.DTOs.BucketResponse? bucket;

    protected override async Task OnInitializedAsync()
    {
        bucket = await BucketService.GetBucketAsync(BucketId);
    }

    private static string FormatSize(long bytes)
    {
        const long kb = 1024;
        const long mb = 1024 * 1024;
        const long gb = 1024 * 1024 * 1024;
        if (bytes >= gb) return $"{bytes / (double)gb:F1} GB";
        if (bytes >= mb) return $"{bytes / (double)mb:F1} MB";
        if (bytes >= kb) return $"{bytes / (double)kb:F1} KB";
        return $"{bytes} B";
    }
}
