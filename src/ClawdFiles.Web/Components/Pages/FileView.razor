@page "/{BucketId}/{*FilePath}"
@using ClawdFiles.Application.Interfaces
@inject IFileHeaderRepository FileRepo
@rendermode InteractiveServer

<PageTitle>@FilePath</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    @if (fileHeader is null)
    {
        <MudText Typo="Typo.body1">File not found.</MudText>
    }
    else
    {
        <MudText Typo="Typo.h4" GutterBottom="true">@fileHeader.Path</MudText>
        <div class="d-flex flex-wrap gap-2 mb-4">
            <MudChip T="string" Color="Color.Default">Type: @fileHeader.ContentType</MudChip>
            <MudChip T="string" Color="Color.Default">Size: @FormatSize(fileHeader.SizeBytes)</MudChip>
            <MudChip T="string" Color="Color.Default">Uploaded: @fileHeader.UploadedAt.ToString("u")</MudChip>
            <MudChip T="string" Color="Color.Info">
                Short URL: <MudLink Href="@($"/s/{fileHeader.ShortCode}")">/s/@fileHeader.ShortCode</MudLink>
            </MudChip>
        </div>

        @if (fileHeader.ContentType.StartsWith("image/"))
        {
            <MudImage Src="@($"/raw/{BucketId}/{FilePath}")"
                      Alt="@fileHeader.Path"
                      Fluid="true"
                      Elevation="1"
                      Class="mb-4" />
        }

        <div class="d-flex gap-2">
            <MudButton Href="@($"/raw/{BucketId}/{FilePath}")"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Download">
                Download
            </MudButton>
            <MudButton Href="@($"/{BucketId}")"
                       Variant="Variant.Outlined"
                       Color="Color.Default"
                       StartIcon="@Icons.Material.Filled.ArrowBack">
                Back to bucket
            </MudButton>
        </div>
    }
</MudContainer>

@code {
    [Parameter] public string BucketId { get; set; } = "";
    [Parameter] public string FilePath { get; set; } = "";
    private ClawdFiles.Domain.Entities.BucketFileHeader? fileHeader;

    protected override async Task OnInitializedAsync()
    {
        fileHeader = await FileRepo.FindByBucketAndPathAsync(BucketId, FilePath);
    }

    private static string FormatSize(long bytes)
    {
        const long kb = 1024;
        const long mb = 1024 * 1024;
        const long gb = 1024 * 1024 * 1024;
        if (bytes >= gb) return $"{bytes / (double)gb:F1} GB";
        if (bytes >= mb) return $"{bytes / (double)mb:F1} MB";
        if (bytes >= kb) return $"{bytes / (double)kb:F1} KB";
        return $"{bytes} B";
    }
}
